<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Blues Yu">





<title>🚰 ELK背压浅探 | 布鲁斯鱼的妙想天开</title>



    <link rel="icon" href="/favicon.svg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">布鲁斯鱼的妙想天开</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">技术</a>
                
                    <a class="menu-item" href="/category">生活</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于我</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">布鲁斯鱼的妙想天开</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">技术</a>
                
                    <a class="menu-item" href="/category">生活</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于我</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // 为 6 时展开所有
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // 这个值是由 tocbot 源码里定义的 scrollSmoothDuration 得来的
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">🚰 ELK背压浅探</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Blues Yu</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">December 21, 2020&nbsp;&nbsp;17:57:20</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>我们在日常使用 ELK 链路的时候，经常会碰到一个问题，由于链路涉及的组件较多，一旦当其中某些组件出现问题，就会出现“事件风暴”，如果没有做好相关的告警或者资源管控，很可能会使链路发生崩溃。</p>
<p>在官方文档中，我们可以看到一个相关的描述：<br><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled.png"></p>
<p>然而，在我们实践过程中并没有图中描绘得如此理想，很多情况下，在后端 ES 写入出现问题时，前端输入（如 filebeat）并不会减慢采集速率，导致中间的缓存队列（Redis）存储爆满，在没有做好资源隔离时，引发其他问题。</p>
<p>所以我们就来仔细研究一下 ELK 背压原理，看看如何才能调试出一条伸缩自如、百折不挠的 ELK 链路。</p>
<h1 id="什么时候触发背压"><a href="#什么时候触发背压" class="headerlink" title="什么时候触发背压"></a>什么时候触发背压</h1><p>Logstash 内部会有一个 buffer 区域缓存一定量的事件，这个队列可以存储在内存或磁盘。一旦当这个队列缓存跑满，Logstash 会反向给事件输入端（Input）施加 “back pressure”（不返回 ACK），限制流量流入。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 缓存落盘</span></span><br><span class="line"><span class="attr">queue.type:</span> <span class="string">persisted</span></span><br><span class="line"><span class="attr">queue.max_bytes:</span> <span class="string">8gb</span></span><br></pre></td></tr></table></figure>

<p>类似我们给这个队列配置 8gb 的缓存，当事件队列里全都是 <code>unACKed</code> 事件，并且缓存达到了 8gb，Logstash 就不再接受任何事件推送，直到将队列内的事件被消费重新恢复。</p>
<p>对于 Input 端而言，官方提供的组件也都实现了类似逻辑，例如 Filebeat，当没有收到 output  ACK 事件数量积累到 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/configuring-internal-queue.html#_events">最大限制（默认 4096）</a> 时，会停止读取文件，直到组件内部缓存队列能够被消费，所以理论上，只要能够通过 TCP 互相连接的组件，ELK 提供的组件应该都是可以实现背压能力的。</p>
<h1 id="ELK-直接传输-vs-外部消息队列"><a href="#ELK-直接传输-vs-外部消息队列" class="headerlink" title="ELK 直接传输 vs 外部消息队列"></a>ELK 直接传输 vs 外部消息队列</h1><p>经典的 ELK 链路中，我们通常为了会扩展 buffer，在 Beats 和 Logstash 之间增加一个中间队列（例如 Kafka、Redis），相比较直接使用 ELK 链路传输，在背压问题上又有哪些优劣呢？</p>
<p>首先是是否都能触发背压？</p>
<p>在上文中提到的，我们使用 Redis 是无法正常触发背压的，理论上说不通。于是经过一番搜索，发现filebeat 需要使用 <code>&gt;=6.4</code>的版本，而我们正好用的是 <code>6.3</code>😂 ⇒ <a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/redis-input-plugin-back-pressure-issue/150826">问题传送门</a>，从问题的描述上来看，只要升级到了 <code>6.4</code> 背压问题就能解决，但没有调查就没有发言权，索性做一个简单的背压测试。</p>
<h2 id="0-准备测试环境"><a href="#0-准备测试环境" class="headerlink" title="0. 准备测试环境"></a>0. 准备测试环境</h2><p>准备一个装好 Helm 的 Kubernetes 集群，然后依次安装所需组件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建议拷贝 values.yaml 作为 values，方便修改</span></span><br><span class="line">helm install dev-filebeat --version 7.10.1 elastic/filebeat --values=filebeat.yaml</span><br><span class="line">helm install dev-logstash --version 7.10.1 elastic/logstash --values=logstash.yaml</span><br><span class="line">helm install dev-redis bitnami/redis --values=redis.yaml</span><br></pre></td></tr></table></figure>

<p>通过 <code>values</code> 配置将三者串联起来，Logstash 可以先配置 <code>output.stdout</code> 直接打印，快速确认链路通常。</p>
<p>准备一个可以不断触发日志的 <code>pod</code> </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">whatever-dummy-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whatever-dummy-pod</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">python:3.6.10-stretch</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-ec&quot;</span>, <span class="string">&quot;while :; do echo &#x27;.&#x27;; sleep 0.1 ; done&quot;</span>]</span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<h2 id="1-外部消息队列"><a href="#1-外部消息队列" class="headerlink" title="1. 外部消息队列"></a>1. 外部消息队列</h2><p>外部消息队列组件较多，一般来说瓶颈可能会出在最后的 ElastcSearch 上，这种情况下，前端的 filebeat 是无法感知的，只要外部消息队列一直可用，filebeat 是不会触发背压。所以我们主要测试 <strong>当外部消息队列也不可用</strong> 的情况。</p>
<p>正常采集，filebeat 采集日志：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">15</span><span class="punctuation">:</span><span class="number">51.663</span>Z	INFO	<span class="punctuation">[</span>monitoring<span class="punctuation">]</span>	log/log.go<span class="punctuation">:</span><span class="number">144</span></span><br><span class="line"># 截取出有用的字段</span><br><span class="line">----</span><br><span class="line"></span><br><span class="line"># 可以看到一共发布了 <span class="number">30</span> 消息，都已经得到 ACK 了</span><br><span class="line"><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;published&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;queue&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">----</span><br></pre></td></tr></table></figure>

<p>关闭 Redis ，立即观察：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">44.272</span>Z	ERROR	<span class="punctuation">[</span>redis<span class="punctuation">]</span>	redis/client.go<span class="punctuation">:</span><span class="number">239</span>	Failed to RPUSH to redis list with<span class="punctuation">:</span> EOF</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">44.272</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">219</span>	retryer<span class="punctuation">:</span> send unwait signal to consumer</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">44.272</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">223</span>	  done</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	ERROR	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">180</span>	failed to publish events<span class="punctuation">:</span> EOF</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	INFO	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">143</span>	Connecting to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379)</span></span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">219</span>	retryer<span class="punctuation">:</span> send unwait signal to consumer</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">223</span>	  done</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.276</span>Z	ERROR	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">154</span>	Failed to connect to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379): dial tcp 10.111.75.89:6379: connect: connection refused</span></span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.277</span>Z	INFO	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">145</span>	Attempting to reconnect to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379) with 1 reconnect attempt(s)</span></span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.277</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">219</span>	retryer<span class="punctuation">:</span> send unwait signal to consumer</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.277</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">223</span>	  done</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">51.663</span>Z	INFO	<span class="punctuation">[</span>monitoring<span class="punctuation">]</span>	log/log.go<span class="punctuation">:</span><span class="number">144</span>	</span><br><span class="line"></span><br><span class="line">----</span><br><span class="line"><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">9</span><span class="punctuation">,</span><span class="attr">&quot;published&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">,</span><span class="attr">&quot;retry&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;queue&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">----</span><br></pre></td></tr></table></figure>

<p>此时，采集并没有停止，队列事件数量上升了，但还没有塞满。</p>
<p>静待一段时间再观察：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">4117</span><span class="punctuation">,</span><span class="attr">&quot;retry&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="attr">&quot;harvester&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;open_files&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;running&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>可以到看到，<code>unACKed</code>的数量超过了默认的 4096，数量停在了 <code>4117</code> 上（<em>为什么是 4117？</em>），没有新的事件推送了，可以认为背压已经生效。（但是要注意，此时<strong>文件句柄并不会释放</strong>，需要 <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html#filebeat-input-log-close-timeout">通过 clost_timeout 来保证机器文件系统健康</a>）</p>
<p>再次打开 Redis</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># redis 重新连上</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">43</span><span class="punctuation">:</span><span class="number">23.335</span>Z	INFO	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">151</span>	Connection to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379) established</span></span><br><span class="line"></span><br><span class="line">----</span><br><span class="line"><span class="attr">&quot;output&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">10207</span><span class="punctuation">,</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;batches&quot;</span><span class="punctuation">:</span><span class="number">33</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">10207</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;read&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span><span class="number">4240</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;write&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span><span class="number">15941956</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span><span class="attr">&quot;published&quot;</span><span class="punctuation">:</span><span class="number">6101</span><span class="punctuation">,</span><span class="attr">&quot;retry&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">6100</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;queue&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">10207</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>unACKed</code> 的事件迅速被消费，背压消失， filebeat 采集恢复正常。</p>
<h2 id="2-直接传输"><a href="#2-直接传输" class="headerlink" title="2. 直接传输"></a>2. 直接传输</h2><p>通过配置，我们将 Redis 挪到 Logstash 后端，再把 filebeat 日志直接怼到 Logstash。需要测试的是，当最后端的 output （例如 ES，我们这里偷懒用了 Redis）挂掉，观察Logstash → FIlebeat 整体的背压情况。</p>
<p>当链路通畅，采集正常后，我们尝试关掉 Redis，然后立即观测 Logstash 日志</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T10<span class="punctuation">:</span><span class="number">03</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">,</span><span class="number">095</span><span class="punctuation">]</span><span class="punctuation">[</span>WARN <span class="punctuation">]</span><span class="punctuation">[</span>logstash.outputs.redis   <span class="punctuation">]</span><span class="punctuation">[</span>main<span class="punctuation">]</span><span class="punctuation">[</span><span class="number">22</span>ee6501492f55ca3f6485661fbbafb6131941aad2d5c08d163a871e724cfb81<span class="punctuation">]</span> Failed to send event to Redis <span class="punctuation">&#123;</span><span class="punctuation">:</span>event=&gt;#&lt;LogStash<span class="punctuation">:</span><span class="punctuation">:</span>Event<span class="punctuation">:</span><span class="number">0x1a2ed42b</span>&gt;<span class="punctuation">,</span> <span class="punctuation">:</span>identity=&gt;(中间省略一万字) `block in start_workers&#x27;<span class="string">&quot;]&#125;</span></span><br></pre></td></tr></table></figure>

<p>这时候我们会发现，Filebeat 的事件队列已经开始堆积了（这里如此敏感，是因为我们 Logstash 只设置了内存队列，空间有限，如果使用了较大的磁盘存储，可能需要积攒非常久），类似 Redis 方案，当队列堆积到 <code>4117</code> 时就不再有新事件采集了。</p>
<p>重新打开 Redis 就绪后，<strong>数秒内</strong> Filebeat 迅速恢复采集，整条链路的感知还是比较灵敏的。</p>
<h1 id="如何观测背压事件？"><a href="#如何观测背压事件？" class="headerlink" title="如何观测背压事件？"></a>如何观测背压事件？</h1><p>一般来说，背压产生的原因通常是链路中有组件发生了异常（例如 ES 状态变红），导致数据流断裂，这是需要维护者介入的重要事件，所以如何能够被及时准确地观测到，是衡量方案的重要指标。</p>
<p>由于我们的使用场景里，ElasticSearch 是托管给其他团队维护的，暂时没有异常告警，所以只能在链路监控上做文章。</p>
<h2 id="外部消息队列"><a href="#外部消息队列" class="headerlink" title="外部消息队列"></a>外部消息队列</h2><p>以 Redis 为例，我们可以比较轻松地监控其队列长度、所消耗的资源量来判断其状态，是比较容易观测的。</p>
<h2 id="直接传输"><a href="#直接传输" class="headerlink" title="直接传输"></a>直接传输</h2><p>在一番简单 Google 之后，发现了悲剧的事实——翻遍了 ES 的论坛和 Github issue，没有找到明确的背压事件标志：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/where-do-incoming-events-go-when-logstash-is-cpu-bound/65197">2016 年有人因为 CPU  吃满而发生背压，发现很难观测</a></li>
<li>同年，在 Github 中也有人创建了 <a target="_blank" rel="noopener" href="https://github.com/elastic/logstash/issues/5317">相关 issue</a> ，然而到现在也无人回应</li>
<li>2018年，<a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/how-can-i-identify-back-pressure-in-logstash/157581">Logstash 如何检测背压事件的问题</a> 也无人回应</li>
</ul>
<p>加上官方文档的语焉不详，看来并没有显式的日志可以轻松地 <strong>直接监测</strong> 到。</p>
<p>但对直接传输方案的偏爱（少一个组件，少点维护成本），经过进一步研究，采用了一个间接观测方法 —— 将 Logstash 的 metrics 转换成 Prometheus 格式（借助 <a target="_blank" rel="noopener" href="https://github.com/BonnierNews/logstash_exporter">logstash_exporter</a>），再根据事件发送和接收的速率判断。</p>
<p><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%201.png"><br>当一切正常<br><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%202.png"></p>
<p>当后端发生异常，out_total 增速会立即小于 in_total</p>
<p>可以比较清晰的看到，Events 的接收和发送都处在一个比较相近的速率，如果在 filter 不出错的情况下，事件发送的速率大大小于事件的接收，就基本说明了后端存在问题，背压应该很快就要被触发了。</p>
<p><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%203.png"><br>背压发生，不再有新的事件推送进来</p>
<p>当背压触发， <code>logstash_node_pipeline_events_in_total</code>  和 <code>logstash_node_pipeline_events_out_total</code> 二者的增速都降为了 0。</p>
<p>所以，解决方法就非常简单了，在 Prometheus 配置类似告警语句即可：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 近十分钟 Logstash 无输入</span></span><br><span class="line">ceil(increase(logstash_node_pipeline_events_in_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m])) &lt;= 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 近十分钟 Logstash 无输出</span></span><br><span class="line">ceil(increase(logstash_node_pipeline_events_out_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m])) &lt;= 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 近十分钟 Logstash 输出输入速度差异过大</span></span><br><span class="line">increase(logstash_node_pipeline_events_out_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m]) / increase(logstash_node_pipeline_events_in_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m]) &lt; 0.5</span><br></pre></td></tr></table></figure>

<p>再配置上简单的图表，就能清晰的看到 Logstash 的采集速率<br><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%204.png"></p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>总结一下上面提到的两种方案，在背压问题上的优劣：</p>
<ul>
<li>外部消息队列在观测上更优，有比较多的方案可以更直观地判断链路健康状态</li>
<li>当背压发生，外部消息队列会将更多内容采集到链路中，而不是暂时让他们呆在硬盘，如果故障处理的速度较慢，那么链路的数据可靠性就非常重要了，一旦链路数据丢失（例如 Redis 未能及时落地，内存事件丢失），日志会有更多丢失</li>
<li>直接传输方案在组件维护、问题排查上更容易</li>
<li>外部消息队列方案要更关注组件版本，对旧系统不那么友好</li>
</ul>
<p>具体选择那种方式采集日志，需要根据实际情况抉择。</p>
<hr>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/where-do-incoming-events-go-when-logstash-is-cpu-bound/65197">https://discuss.elastic.co/t/where-do-incoming-events-go-when-logstash-is-cpu-bound/65197</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/persistent-queues.html">https://www.elastic.co/guide/en/logstash/current/persistent-queues.html</a></li>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/redis-input-plugin-back-pressure-issue/150826">https://discuss.elastic.co/t/redis-input-plugin-back-pressure-issue/150826</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/elastic/beats/issues/7743">https://github.com/elastic/beats/issues/7743</a></li>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/filebeat-harvester-open-file-count-increasing-when-logstash-output-to-elasticsearch-fails/249892">https://discuss.elastic.co/t/filebeat-harvester-open-file-count-increasing-when-logstash-output-to-elasticsearch-fails/249892</a></li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Blues Yu</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://emergencyexit.xyz/elk-back-pressure-study.html">https://emergencyexit.xyz/elk-back-pressure-study.html</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2025 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/tech/"># tech</a>
                    
                        <a href="/tags/ELK/"># ELK</a>
                    
                        <a href="/tags/back-pressure/"># back-pressure</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/use-pytest-fixture-factory.html">善用 pytest fixture factory 构建结构优秀的单元测试</a>
            
            
            <a class="next" rel="next" href="/use-pyprojects-toml-as-project-tool.html">使用 pyproject.toml 管理你的 Python 项目</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Blues Yu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>
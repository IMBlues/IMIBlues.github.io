<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Blues Yu">





<title>ğŸš° ELKèƒŒå‹æµ…æ¢ | å¸ƒé²æ–¯é±¼çš„å¦™æƒ³å¤©å¼€</title>



    <link rel="icon" href="/favicon.svg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">å¸ƒé²æ–¯é±¼çš„å¦™æƒ³å¤©å¼€</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">æŠ€æœ¯</a>
                
                    <a class="menu-item" href="/category">ç”Ÿæ´»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">å¸ƒé²æ–¯é±¼çš„å¦™æƒ³å¤©å¼€</a><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">æŠ€æœ¯</a>
                
                    <a class="menu-item" href="/category">ç”Ÿæ´»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // ä¸º 6 æ—¶å±•å¼€æ‰€æœ‰
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // è¿™ä¸ªå€¼æ˜¯ç”± tocbot æºç é‡Œå®šä¹‰çš„ scrollSmoothDuration å¾—æ¥çš„
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">ğŸš° ELKèƒŒå‹æµ…æ¢</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Blues Yu</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">December 21, 2020&nbsp;&nbsp;17:57:20</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>æˆ‘ä»¬åœ¨æ—¥å¸¸ä½¿ç”¨ ELK é“¾è·¯çš„æ—¶å€™ï¼Œç»å¸¸ä¼šç¢°åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºé“¾è·¯æ¶‰åŠçš„ç»„ä»¶è¾ƒå¤šï¼Œä¸€æ—¦å½“å…¶ä¸­æŸäº›ç»„ä»¶å‡ºç°é—®é¢˜ï¼Œå°±ä¼šå‡ºç°â€œäº‹ä»¶é£æš´â€ï¼Œå¦‚æœæ²¡æœ‰åšå¥½ç›¸å…³çš„å‘Šè­¦æˆ–è€…èµ„æºç®¡æ§ï¼Œå¾ˆå¯èƒ½ä¼šä½¿é“¾è·¯å‘ç”Ÿå´©æºƒã€‚</p>
<p>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç›¸å…³çš„æè¿°ï¼š<br><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled.png"></p>
<p>ç„¶è€Œï¼Œåœ¨æˆ‘ä»¬å®è·µè¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å›¾ä¸­æç»˜å¾—å¦‚æ­¤ç†æƒ³ï¼Œå¾ˆå¤šæƒ…å†µä¸‹ï¼Œåœ¨åç«¯ ES å†™å…¥å‡ºç°é—®é¢˜æ—¶ï¼Œå‰ç«¯è¾“å…¥ï¼ˆå¦‚ filebeatï¼‰å¹¶ä¸ä¼šå‡æ…¢é‡‡é›†é€Ÿç‡ï¼Œå¯¼è‡´ä¸­é—´çš„ç¼“å­˜é˜Ÿåˆ—ï¼ˆRedisï¼‰å­˜å‚¨çˆ†æ»¡ï¼Œåœ¨æ²¡æœ‰åšå¥½èµ„æºéš”ç¦»æ—¶ï¼Œå¼•å‘å…¶ä»–é—®é¢˜ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å°±æ¥ä»”ç»†ç ”ç©¶ä¸€ä¸‹ ELK èƒŒå‹åŸç†ï¼Œçœ‹çœ‹å¦‚ä½•æ‰èƒ½è°ƒè¯•å‡ºä¸€æ¡ä¼¸ç¼©è‡ªå¦‚ã€ç™¾æŠ˜ä¸æŒ çš„ ELK é“¾è·¯ã€‚</p>
<h1 id="ä»€ä¹ˆæ—¶å€™è§¦å‘èƒŒå‹"><a href="#ä»€ä¹ˆæ—¶å€™è§¦å‘èƒŒå‹" class="headerlink" title="ä»€ä¹ˆæ—¶å€™è§¦å‘èƒŒå‹"></a>ä»€ä¹ˆæ—¶å€™è§¦å‘èƒŒå‹</h1><p>Logstash å†…éƒ¨ä¼šæœ‰ä¸€ä¸ª buffer åŒºåŸŸç¼“å­˜ä¸€å®šé‡çš„äº‹ä»¶ï¼Œè¿™ä¸ªé˜Ÿåˆ—å¯ä»¥å­˜å‚¨åœ¨å†…å­˜æˆ–ç£ç›˜ã€‚ä¸€æ—¦å½“è¿™ä¸ªé˜Ÿåˆ—ç¼“å­˜è·‘æ»¡ï¼ŒLogstash ä¼šåå‘ç»™äº‹ä»¶è¾“å…¥ç«¯ï¼ˆInputï¼‰æ–½åŠ  â€œback pressureâ€ï¼ˆä¸è¿”å› ACKï¼‰ï¼Œé™åˆ¶æµé‡æµå…¥ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼“å­˜è½ç›˜</span></span><br><span class="line"><span class="attr">queue.type:</span> <span class="string">persisted</span></span><br><span class="line"><span class="attr">queue.max_bytes:</span> <span class="string">8gb</span></span><br></pre></td></tr></table></figure>

<p>ç±»ä¼¼æˆ‘ä»¬ç»™è¿™ä¸ªé˜Ÿåˆ—é…ç½® 8gb çš„ç¼“å­˜ï¼Œå½“äº‹ä»¶é˜Ÿåˆ—é‡Œå…¨éƒ½æ˜¯ <code>unACKed</code> äº‹ä»¶ï¼Œå¹¶ä¸”ç¼“å­˜è¾¾åˆ°äº† 8gbï¼ŒLogstash å°±ä¸å†æ¥å—ä»»ä½•äº‹ä»¶æ¨é€ï¼Œç›´åˆ°å°†é˜Ÿåˆ—å†…çš„äº‹ä»¶è¢«æ¶ˆè´¹é‡æ–°æ¢å¤ã€‚</p>
<p>å¯¹äº Input ç«¯è€Œè¨€ï¼Œå®˜æ–¹æä¾›çš„ç»„ä»¶ä¹Ÿéƒ½å®ç°äº†ç±»ä¼¼é€»è¾‘ï¼Œä¾‹å¦‚ Filebeatï¼Œå½“æ²¡æœ‰æ”¶åˆ° output  ACK äº‹ä»¶æ•°é‡ç§¯ç´¯åˆ° <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/configuring-internal-queue.html#_events">æœ€å¤§é™åˆ¶ï¼ˆé»˜è®¤ 4096ï¼‰</a> æ—¶ï¼Œä¼šåœæ­¢è¯»å–æ–‡ä»¶ï¼Œç›´åˆ°ç»„ä»¶å†…éƒ¨ç¼“å­˜é˜Ÿåˆ—èƒ½å¤Ÿè¢«æ¶ˆè´¹ï¼Œæ‰€ä»¥ç†è®ºä¸Šï¼Œåªè¦èƒ½å¤Ÿé€šè¿‡ TCP äº’ç›¸è¿æ¥çš„ç»„ä»¶ï¼ŒELK æä¾›çš„ç»„ä»¶åº”è¯¥éƒ½æ˜¯å¯ä»¥å®ç°èƒŒå‹èƒ½åŠ›çš„ã€‚</p>
<h1 id="ELK-ç›´æ¥ä¼ è¾“-vs-å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—"><a href="#ELK-ç›´æ¥ä¼ è¾“-vs-å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="ELK ç›´æ¥ä¼ è¾“ vs å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—"></a>ELK ç›´æ¥ä¼ è¾“ vs å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—</h1><p>ç»å…¸çš„ ELK é“¾è·¯ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ºäº†ä¼šæ‰©å±• bufferï¼Œåœ¨ Beats å’Œ Logstash ä¹‹é—´å¢åŠ ä¸€ä¸ªä¸­é—´é˜Ÿåˆ—ï¼ˆä¾‹å¦‚ Kafkaã€Redisï¼‰ï¼Œç›¸æ¯”è¾ƒç›´æ¥ä½¿ç”¨ ELK é“¾è·¯ä¼ è¾“ï¼Œåœ¨èƒŒå‹é—®é¢˜ä¸Šåˆæœ‰å“ªäº›ä¼˜åŠ£å‘¢ï¼Ÿ</p>
<p>é¦–å…ˆæ˜¯æ˜¯å¦éƒ½èƒ½è§¦å‘èƒŒå‹ï¼Ÿ</p>
<p>åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ Redis æ˜¯æ— æ³•æ­£å¸¸è§¦å‘èƒŒå‹çš„ï¼Œç†è®ºä¸Šè¯´ä¸é€šã€‚äºæ˜¯ç»è¿‡ä¸€ç•ªæœç´¢ï¼Œå‘ç°filebeat éœ€è¦ä½¿ç”¨ <code>&gt;=6.4</code>çš„ç‰ˆæœ¬ï¼Œè€Œæˆ‘ä»¬æ­£å¥½ç”¨çš„æ˜¯ <code>6.3</code>ğŸ˜‚ â‡’ <a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/redis-input-plugin-back-pressure-issue/150826">é—®é¢˜ä¼ é€é—¨</a>ï¼Œä»é—®é¢˜çš„æè¿°ä¸Šæ¥çœ‹ï¼Œåªè¦å‡çº§åˆ°äº† <code>6.4</code> èƒŒå‹é—®é¢˜å°±èƒ½è§£å†³ï¼Œä½†æ²¡æœ‰è°ƒæŸ¥å°±æ²¡æœ‰å‘è¨€æƒï¼Œç´¢æ€§åšä¸€ä¸ªç®€å•çš„èƒŒå‹æµ‹è¯•ã€‚</p>
<h2 id="0-å‡†å¤‡æµ‹è¯•ç¯å¢ƒ"><a href="#0-å‡†å¤‡æµ‹è¯•ç¯å¢ƒ" class="headerlink" title="0. å‡†å¤‡æµ‹è¯•ç¯å¢ƒ"></a>0. å‡†å¤‡æµ‹è¯•ç¯å¢ƒ</h2><p>å‡†å¤‡ä¸€ä¸ªè£…å¥½ Helm çš„ Kubernetes é›†ç¾¤ï¼Œç„¶åä¾æ¬¡å®‰è£…æ‰€éœ€ç»„ä»¶ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å»ºè®®æ‹·è´ values.yaml ä½œä¸º valuesï¼Œæ–¹ä¾¿ä¿®æ”¹</span></span><br><span class="line">helm install dev-filebeat --version 7.10.1 elastic/filebeat --values=filebeat.yaml</span><br><span class="line">helm install dev-logstash --version 7.10.1 elastic/logstash --values=logstash.yaml</span><br><span class="line">helm install dev-redis bitnami/redis --values=redis.yaml</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ <code>values</code> é…ç½®å°†ä¸‰è€…ä¸²è”èµ·æ¥ï¼ŒLogstash å¯ä»¥å…ˆé…ç½® <code>output.stdout</code> ç›´æ¥æ‰“å°ï¼Œå¿«é€Ÿç¡®è®¤é“¾è·¯é€šå¸¸ã€‚</p>
<p>å‡†å¤‡ä¸€ä¸ªå¯ä»¥ä¸æ–­è§¦å‘æ—¥å¿—çš„ <code>pod</code> </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">whatever-dummy-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">whatever-dummy-pod</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">python:3.6.10-stretch</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-ec&quot;</span>, <span class="string">&quot;while :; do echo &#x27;.&#x27;; sleep 0.1 ; done&quot;</span>]</span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<h2 id="1-å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—"><a href="#1-å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="1. å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—"></a>1. å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—</h2><p>å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—ç»„ä»¶è¾ƒå¤šï¼Œä¸€èˆ¬æ¥è¯´ç“¶é¢ˆå¯èƒ½ä¼šå‡ºåœ¨æœ€åçš„ ElastcSearch ä¸Šï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œå‰ç«¯çš„ filebeat æ˜¯æ— æ³•æ„ŸçŸ¥çš„ï¼Œåªè¦å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸€ç›´å¯ç”¨ï¼Œfilebeat æ˜¯ä¸ä¼šè§¦å‘èƒŒå‹ã€‚æ‰€ä»¥æˆ‘ä»¬ä¸»è¦æµ‹è¯• <strong>å½“å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—ä¹Ÿä¸å¯ç”¨</strong> çš„æƒ…å†µã€‚</p>
<p>æ­£å¸¸é‡‡é›†ï¼Œfilebeat é‡‡é›†æ—¥å¿—ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">15</span><span class="punctuation">:</span><span class="number">51.663</span>Z	INFO	<span class="punctuation">[</span>monitoring<span class="punctuation">]</span>	log/log.go<span class="punctuation">:</span><span class="number">144</span></span><br><span class="line"># æˆªå–å‡ºæœ‰ç”¨çš„å­—æ®µ</span><br><span class="line">----</span><br><span class="line"></span><br><span class="line"># å¯ä»¥çœ‹åˆ°ä¸€å…±å‘å¸ƒäº† <span class="number">30</span> æ¶ˆæ¯ï¼Œéƒ½å·²ç»å¾—åˆ° ACK äº†</span><br><span class="line"><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;published&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;queue&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">----</span><br></pre></td></tr></table></figure>

<p>å…³é—­ Redis ï¼Œç«‹å³è§‚å¯Ÿï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">44.272</span>Z	ERROR	<span class="punctuation">[</span>redis<span class="punctuation">]</span>	redis/client.go<span class="punctuation">:</span><span class="number">239</span>	Failed to RPUSH to redis list with<span class="punctuation">:</span> EOF</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">44.272</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">219</span>	retryer<span class="punctuation">:</span> send unwait signal to consumer</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">44.272</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">223</span>	  done</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	ERROR	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">180</span>	failed to publish events<span class="punctuation">:</span> EOF</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	INFO	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">143</span>	Connecting to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379)</span></span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">219</span>	retryer<span class="punctuation">:</span> send unwait signal to consumer</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">46.074</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">223</span>	  done</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.276</span>Z	ERROR	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">154</span>	Failed to connect to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379): dial tcp 10.111.75.89:6379: connect: connection refused</span></span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.277</span>Z	INFO	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">145</span>	Attempting to reconnect to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379) with 1 reconnect attempt(s)</span></span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.277</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">219</span>	retryer<span class="punctuation">:</span> send unwait signal to consumer</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">50.277</span>Z	INFO	<span class="punctuation">[</span>publisher<span class="punctuation">]</span>	pipeline/retry.go<span class="punctuation">:</span><span class="number">223</span>	  done</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">17</span><span class="punctuation">:</span><span class="number">51.663</span>Z	INFO	<span class="punctuation">[</span>monitoring<span class="punctuation">]</span>	log/log.go<span class="punctuation">:</span><span class="number">144</span>	</span><br><span class="line"></span><br><span class="line">----</span><br><span class="line"><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">9</span><span class="punctuation">,</span><span class="attr">&quot;published&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">,</span><span class="attr">&quot;retry&quot;</span><span class="punctuation">:</span><span class="number">2</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> <span class="attr">&quot;queue&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">22</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line">----</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼Œé‡‡é›†å¹¶æ²¡æœ‰åœæ­¢ï¼Œé˜Ÿåˆ—äº‹ä»¶æ•°é‡ä¸Šå‡äº†ï¼Œä½†è¿˜æ²¡æœ‰å¡æ»¡ã€‚</p>
<p>é™å¾…ä¸€æ®µæ—¶é—´å†è§‚å¯Ÿï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">4117</span><span class="punctuation">,</span><span class="attr">&quot;retry&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="attr">&quot;harvester&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;open_files&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;running&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åˆ°çœ‹åˆ°ï¼Œ<code>unACKed</code>çš„æ•°é‡è¶…è¿‡äº†é»˜è®¤çš„ 4096ï¼Œæ•°é‡åœåœ¨äº† <code>4117</code> ä¸Šï¼ˆ<em>ä¸ºä»€ä¹ˆæ˜¯ 4117ï¼Ÿ</em>ï¼‰ï¼Œæ²¡æœ‰æ–°çš„äº‹ä»¶æ¨é€äº†ï¼Œå¯ä»¥è®¤ä¸ºèƒŒå‹å·²ç»ç”Ÿæ•ˆã€‚ï¼ˆä½†æ˜¯è¦æ³¨æ„ï¼Œæ­¤æ—¶<strong>æ–‡ä»¶å¥æŸ„å¹¶ä¸ä¼šé‡Šæ”¾</strong>ï¼Œéœ€è¦ <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-input-log.html#filebeat-input-log-close-timeout">é€šè¿‡ clost_timeout æ¥ä¿è¯æœºå™¨æ–‡ä»¶ç³»ç»Ÿå¥åº·</a>ï¼‰</p>
<p>å†æ¬¡æ‰“å¼€ Redis</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># redis é‡æ–°è¿ä¸Š</span><br><span class="line"><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T08<span class="punctuation">:</span><span class="number">43</span><span class="punctuation">:</span><span class="number">23.335</span>Z	INFO	<span class="punctuation">[</span>publisher_pipeline_output<span class="punctuation">]</span>	pipeline/output.go<span class="punctuation">:</span><span class="number">151</span>	Connection to redis(tcp<span class="punctuation">:</span><span class="comment">//dev-redis-master:6379) established</span></span><br><span class="line"></span><br><span class="line">----</span><br><span class="line"><span class="attr">&quot;output&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">10207</span><span class="punctuation">,</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span><span class="attr">&quot;batches&quot;</span><span class="punctuation">:</span><span class="number">33</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">10207</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;read&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span><span class="number">4240</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;write&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;bytes&quot;</span><span class="punctuation">:</span><span class="number">15941956</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;pipeline&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;clients&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span><span class="attr">&quot;events&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;active&quot;</span><span class="punctuation">:</span><span class="number">10</span><span class="punctuation">,</span><span class="attr">&quot;published&quot;</span><span class="punctuation">:</span><span class="number">6101</span><span class="punctuation">,</span><span class="attr">&quot;retry&quot;</span><span class="punctuation">:</span><span class="number">3</span><span class="punctuation">,</span><span class="attr">&quot;total&quot;</span><span class="punctuation">:</span><span class="number">6100</span><span class="punctuation">&#125;</span><span class="punctuation">,</span><span class="attr">&quot;queue&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="attr">&quot;acked&quot;</span><span class="punctuation">:</span><span class="number">10207</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>unACKed</code> çš„äº‹ä»¶è¿…é€Ÿè¢«æ¶ˆè´¹ï¼ŒèƒŒå‹æ¶ˆå¤±ï¼Œ filebeat é‡‡é›†æ¢å¤æ­£å¸¸ã€‚</p>
<h2 id="2-ç›´æ¥ä¼ è¾“"><a href="#2-ç›´æ¥ä¼ è¾“" class="headerlink" title="2. ç›´æ¥ä¼ è¾“"></a>2. ç›´æ¥ä¼ è¾“</h2><p>é€šè¿‡é…ç½®ï¼Œæˆ‘ä»¬å°† Redis æŒªåˆ° Logstash åç«¯ï¼Œå†æŠŠ filebeat æ—¥å¿—ç›´æ¥æ€¼åˆ° Logstashã€‚éœ€è¦æµ‹è¯•çš„æ˜¯ï¼Œå½“æœ€åç«¯çš„ output ï¼ˆä¾‹å¦‚ ESï¼Œæˆ‘ä»¬è¿™é‡Œå·æ‡’ç”¨äº† Redisï¼‰æŒ‚æ‰ï¼Œè§‚å¯ŸLogstash â†’ FIlebeat æ•´ä½“çš„èƒŒå‹æƒ…å†µã€‚</p>
<p>å½“é“¾è·¯é€šç•…ï¼Œé‡‡é›†æ­£å¸¸åï¼Œæˆ‘ä»¬å°è¯•å…³æ‰ Redisï¼Œç„¶åç«‹å³è§‚æµ‹ Logstash æ—¥å¿—</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="number">2020</span><span class="number">-12</span><span class="number">-17</span>T10<span class="punctuation">:</span><span class="number">03</span><span class="punctuation">:</span><span class="number">30</span><span class="punctuation">,</span><span class="number">095</span><span class="punctuation">]</span><span class="punctuation">[</span>WARN <span class="punctuation">]</span><span class="punctuation">[</span>logstash.outputs.redis   <span class="punctuation">]</span><span class="punctuation">[</span>main<span class="punctuation">]</span><span class="punctuation">[</span><span class="number">22</span>ee6501492f55ca3f6485661fbbafb6131941aad2d5c08d163a871e724cfb81<span class="punctuation">]</span> Failed to send event to Redis <span class="punctuation">&#123;</span><span class="punctuation">:</span>event=&gt;#&lt;LogStash<span class="punctuation">:</span><span class="punctuation">:</span>Event<span class="punctuation">:</span><span class="number">0x1a2ed42b</span>&gt;<span class="punctuation">,</span> <span class="punctuation">:</span>identity=&gt;(ä¸­é—´çœç•¥ä¸€ä¸‡å­—) `block in start_workers&#x27;<span class="string">&quot;]&#125;</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™æˆ‘ä»¬ä¼šå‘ç°ï¼ŒFilebeat çš„äº‹ä»¶é˜Ÿåˆ—å·²ç»å¼€å§‹å †ç§¯äº†ï¼ˆè¿™é‡Œå¦‚æ­¤æ•æ„Ÿï¼Œæ˜¯å› ä¸ºæˆ‘ä»¬ Logstash åªè®¾ç½®äº†å†…å­˜é˜Ÿåˆ—ï¼Œç©ºé—´æœ‰é™ï¼Œå¦‚æœä½¿ç”¨äº†è¾ƒå¤§çš„ç£ç›˜å­˜å‚¨ï¼Œå¯èƒ½éœ€è¦ç§¯æ”’éå¸¸ä¹…ï¼‰ï¼Œç±»ä¼¼ Redis æ–¹æ¡ˆï¼Œå½“é˜Ÿåˆ—å †ç§¯åˆ° <code>4117</code> æ—¶å°±ä¸å†æœ‰æ–°äº‹ä»¶é‡‡é›†äº†ã€‚</p>
<p>é‡æ–°æ‰“å¼€ Redis å°±ç»ªåï¼Œ<strong>æ•°ç§’å†…</strong> Filebeat è¿…é€Ÿæ¢å¤é‡‡é›†ï¼Œæ•´æ¡é“¾è·¯çš„æ„ŸçŸ¥è¿˜æ˜¯æ¯”è¾ƒçµæ•çš„ã€‚</p>
<h1 id="å¦‚ä½•è§‚æµ‹èƒŒå‹äº‹ä»¶ï¼Ÿ"><a href="#å¦‚ä½•è§‚æµ‹èƒŒå‹äº‹ä»¶ï¼Ÿ" class="headerlink" title="å¦‚ä½•è§‚æµ‹èƒŒå‹äº‹ä»¶ï¼Ÿ"></a>å¦‚ä½•è§‚æµ‹èƒŒå‹äº‹ä»¶ï¼Ÿ</h1><p>ä¸€èˆ¬æ¥è¯´ï¼ŒèƒŒå‹äº§ç”Ÿçš„åŸå› é€šå¸¸æ˜¯é“¾è·¯ä¸­æœ‰ç»„ä»¶å‘ç”Ÿäº†å¼‚å¸¸ï¼ˆä¾‹å¦‚ ES çŠ¶æ€å˜çº¢ï¼‰ï¼Œå¯¼è‡´æ•°æ®æµæ–­è£‚ï¼Œè¿™æ˜¯éœ€è¦ç»´æŠ¤è€…ä»‹å…¥çš„é‡è¦äº‹ä»¶ï¼Œæ‰€ä»¥å¦‚ä½•èƒ½å¤Ÿè¢«åŠæ—¶å‡†ç¡®åœ°è§‚æµ‹åˆ°ï¼Œæ˜¯è¡¡é‡æ–¹æ¡ˆçš„é‡è¦æŒ‡æ ‡ã€‚</p>
<p>ç”±äºæˆ‘ä»¬çš„ä½¿ç”¨åœºæ™¯é‡Œï¼ŒElasticSearch æ˜¯æ‰˜ç®¡ç»™å…¶ä»–å›¢é˜Ÿç»´æŠ¤çš„ï¼Œæš‚æ—¶æ²¡æœ‰å¼‚å¸¸å‘Šè­¦ï¼Œæ‰€ä»¥åªèƒ½åœ¨é“¾è·¯ç›‘æ§ä¸Šåšæ–‡ç« ã€‚</p>
<h2 id="å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—"><a href="#å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—"></a>å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—</h2><p>ä»¥ Redis ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒè½»æ¾åœ°ç›‘æ§å…¶é˜Ÿåˆ—é•¿åº¦ã€æ‰€æ¶ˆè€—çš„èµ„æºé‡æ¥åˆ¤æ–­å…¶çŠ¶æ€ï¼Œæ˜¯æ¯”è¾ƒå®¹æ˜“è§‚æµ‹çš„ã€‚</p>
<h2 id="ç›´æ¥ä¼ è¾“"><a href="#ç›´æ¥ä¼ è¾“" class="headerlink" title="ç›´æ¥ä¼ è¾“"></a>ç›´æ¥ä¼ è¾“</h2><p>åœ¨ä¸€ç•ªç®€å• Google ä¹‹åï¼Œå‘ç°äº†æ‚²å‰§çš„äº‹å®â€”â€”ç¿»éäº† ES çš„è®ºå›å’Œ Github issueï¼Œæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„èƒŒå‹äº‹ä»¶æ ‡å¿—ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/where-do-incoming-events-go-when-logstash-is-cpu-bound/65197">2016 å¹´æœ‰äººå› ä¸º CPU  åƒæ»¡è€Œå‘ç”ŸèƒŒå‹ï¼Œå‘ç°å¾ˆéš¾è§‚æµ‹</a></li>
<li>åŒå¹´ï¼Œåœ¨ Github ä¸­ä¹Ÿæœ‰äººåˆ›å»ºäº† <a target="_blank" rel="noopener" href="https://github.com/elastic/logstash/issues/5317">ç›¸å…³ issue</a> ï¼Œç„¶è€Œåˆ°ç°åœ¨ä¹Ÿæ— äººå›åº”</li>
<li>2018å¹´ï¼Œ<a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/how-can-i-identify-back-pressure-in-logstash/157581">Logstash å¦‚ä½•æ£€æµ‹èƒŒå‹äº‹ä»¶çš„é—®é¢˜</a> ä¹Ÿæ— äººå›åº”</li>
</ul>
<p>åŠ ä¸Šå®˜æ–¹æ–‡æ¡£çš„è¯­ç„‰ä¸è¯¦ï¼Œçœ‹æ¥å¹¶æ²¡æœ‰æ˜¾å¼çš„æ—¥å¿—å¯ä»¥è½»æ¾åœ° <strong>ç›´æ¥ç›‘æµ‹</strong> åˆ°ã€‚</p>
<p>ä½†å¯¹ç›´æ¥ä¼ è¾“æ–¹æ¡ˆçš„åçˆ±ï¼ˆå°‘ä¸€ä¸ªç»„ä»¶ï¼Œå°‘ç‚¹ç»´æŠ¤æˆæœ¬ï¼‰ï¼Œç»è¿‡è¿›ä¸€æ­¥ç ”ç©¶ï¼Œé‡‡ç”¨äº†ä¸€ä¸ªé—´æ¥è§‚æµ‹æ–¹æ³• â€”â€” å°† Logstash çš„ metrics è½¬æ¢æˆ Prometheus æ ¼å¼ï¼ˆå€ŸåŠ© <a target="_blank" rel="noopener" href="https://github.com/BonnierNews/logstash_exporter">logstash_exporter</a>ï¼‰ï¼Œå†æ ¹æ®äº‹ä»¶å‘é€å’Œæ¥æ”¶çš„é€Ÿç‡åˆ¤æ–­ã€‚</p>
<p><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%201.png"><br>å½“ä¸€åˆ‡æ­£å¸¸<br><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%202.png"></p>
<p>å½“åç«¯å‘ç”Ÿå¼‚å¸¸ï¼Œout_total å¢é€Ÿä¼šç«‹å³å°äº in_total</p>
<p>å¯ä»¥æ¯”è¾ƒæ¸…æ™°çš„çœ‹åˆ°ï¼ŒEvents çš„æ¥æ”¶å’Œå‘é€éƒ½å¤„åœ¨ä¸€ä¸ªæ¯”è¾ƒç›¸è¿‘çš„é€Ÿç‡ï¼Œå¦‚æœåœ¨ filter ä¸å‡ºé”™çš„æƒ…å†µä¸‹ï¼Œäº‹ä»¶å‘é€çš„é€Ÿç‡å¤§å¤§å°äºäº‹ä»¶çš„æ¥æ”¶ï¼Œå°±åŸºæœ¬è¯´æ˜äº†åç«¯å­˜åœ¨é—®é¢˜ï¼ŒèƒŒå‹åº”è¯¥å¾ˆå¿«å°±è¦è¢«è§¦å‘äº†ã€‚</p>
<p><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%203.png"><br>èƒŒå‹å‘ç”Ÿï¼Œä¸å†æœ‰æ–°çš„äº‹ä»¶æ¨é€è¿›æ¥</p>
<p>å½“èƒŒå‹è§¦å‘ï¼Œ <code>logstash_node_pipeline_events_in_total</code>  å’Œ <code>logstash_node_pipeline_events_out_total</code> äºŒè€…çš„å¢é€Ÿéƒ½é™ä¸ºäº† 0ã€‚</p>
<p>æ‰€ä»¥ï¼Œè§£å†³æ–¹æ³•å°±éå¸¸ç®€å•äº†ï¼Œåœ¨ Prometheus é…ç½®ç±»ä¼¼å‘Šè­¦è¯­å¥å³å¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿‘ååˆ†é’Ÿ Logstash æ— è¾“å…¥</span></span><br><span class="line">ceil(increase(logstash_node_pipeline_events_in_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m])) &lt;= 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿‘ååˆ†é’Ÿ Logstash æ— è¾“å‡º</span></span><br><span class="line">ceil(increase(logstash_node_pipeline_events_out_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m])) &lt;= 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿‘ååˆ†é’Ÿ Logstash è¾“å‡ºè¾“å…¥é€Ÿåº¦å·®å¼‚è¿‡å¤§</span></span><br><span class="line">increase(logstash_node_pipeline_events_out_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m]) / increase(logstash_node_pipeline_events_in_total&#123;pipeline=<span class="string">&quot;main&quot;</span>&#125;[10m]) &lt; 0.5</span><br></pre></td></tr></table></figure>

<p>å†é…ç½®ä¸Šç®€å•çš„å›¾è¡¨ï¼Œå°±èƒ½æ¸…æ™°çš„çœ‹åˆ° Logstash çš„é‡‡é›†é€Ÿç‡<br><img src="/../images/%F0%9F%9A%B0%20ELK%E8%83%8C%E5%8E%8B%E6%B5%85%E6%8E%A2/Untitled%204.png"></p>
<h1 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h1><p>æ€»ç»“ä¸€ä¸‹ä¸Šé¢æåˆ°çš„ä¸¤ç§æ–¹æ¡ˆï¼Œåœ¨èƒŒå‹é—®é¢˜ä¸Šçš„ä¼˜åŠ£ï¼š</p>
<ul>
<li>å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—åœ¨è§‚æµ‹ä¸Šæ›´ä¼˜ï¼Œæœ‰æ¯”è¾ƒå¤šçš„æ–¹æ¡ˆå¯ä»¥æ›´ç›´è§‚åœ°åˆ¤æ–­é“¾è·¯å¥åº·çŠ¶æ€</li>
<li>å½“èƒŒå‹å‘ç”Ÿï¼Œå¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—ä¼šå°†æ›´å¤šå†…å®¹é‡‡é›†åˆ°é“¾è·¯ä¸­ï¼Œè€Œä¸æ˜¯æš‚æ—¶è®©ä»–ä»¬å‘†åœ¨ç¡¬ç›˜ï¼Œå¦‚æœæ•…éšœå¤„ç†çš„é€Ÿåº¦è¾ƒæ…¢ï¼Œé‚£ä¹ˆé“¾è·¯çš„æ•°æ®å¯é æ€§å°±éå¸¸é‡è¦äº†ï¼Œä¸€æ—¦é“¾è·¯æ•°æ®ä¸¢å¤±ï¼ˆä¾‹å¦‚ Redis æœªèƒ½åŠæ—¶è½åœ°ï¼Œå†…å­˜äº‹ä»¶ä¸¢å¤±ï¼‰ï¼Œæ—¥å¿—ä¼šæœ‰æ›´å¤šä¸¢å¤±</li>
<li>ç›´æ¥ä¼ è¾“æ–¹æ¡ˆåœ¨ç»„ä»¶ç»´æŠ¤ã€é—®é¢˜æ’æŸ¥ä¸Šæ›´å®¹æ˜“</li>
<li>å¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—æ–¹æ¡ˆè¦æ›´å…³æ³¨ç»„ä»¶ç‰ˆæœ¬ï¼Œå¯¹æ—§ç³»ç»Ÿä¸é‚£ä¹ˆå‹å¥½</li>
</ul>
<p>å…·ä½“é€‰æ‹©é‚£ç§æ–¹å¼é‡‡é›†æ—¥å¿—ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µæŠ‰æ‹©ã€‚</p>
<hr>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/where-do-incoming-events-go-when-logstash-is-cpu-bound/65197">https://discuss.elastic.co/t/where-do-incoming-events-go-when-logstash-is-cpu-bound/65197</a></li>
<li><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/logstash/current/persistent-queues.html">https://www.elastic.co/guide/en/logstash/current/persistent-queues.html</a></li>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/redis-input-plugin-back-pressure-issue/150826">https://discuss.elastic.co/t/redis-input-plugin-back-pressure-issue/150826</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/elastic/beats/issues/7743">https://github.com/elastic/beats/issues/7743</a></li>
<li><a target="_blank" rel="noopener" href="https://discuss.elastic.co/t/filebeat-harvester-open-file-count-increasing-when-logstash-output-to-elasticsearch-fails/249892">https://discuss.elastic.co/t/filebeat-harvester-open-file-count-increasing-when-logstash-output-to-elasticsearch-fails/249892</a></li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Blues Yu</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://emergencyexit.xyz/elk-back-pressure-study.html">https://emergencyexit.xyz/elk-back-pressure-study.html</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2025 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/tech/"># tech</a>
                    
                        <a href="/tags/ELK/"># ELK</a>
                    
                        <a href="/tags/back-pressure/"># back-pressure</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>Â· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/use-pytest-fixture-factory.html">å–„ç”¨ pytest fixture factory æ„å»ºç»“æ„ä¼˜ç§€çš„å•å…ƒæµ‹è¯•</a>
            
            
            <a class="next" rel="next" href="/use-pyprojects-toml-as-project-tool.html">ä½¿ç”¨ pyproject.toml ç®¡ç†ä½ çš„ Python é¡¹ç›®</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Â© Blues Yu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>
<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Blues Yu">





<title>ğŸ§Ÿâ€â™‚ï¸ FileBeat å¯åŠ¨å‡æ­»é—®é¢˜ | å¸ƒé²æ–¯é±¼çš„å¦™æƒ³å¤©å¼€</title>



    <link rel="icon" href="/favicon.svg">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 7.3.0"></head>

<body>
    <script>
        // this function is used to check current theme before page loaded.
        (() => {
            const currentTheme = window.localStorage && window.localStorage.getItem('theme') || '';
            const isDark = currentTheme === 'dark';
            const pagebody = document.getElementsByTagName('body')[0]
            if (isDark) {
                pagebody.classList.add('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Dark"
            } else {
                pagebody.classList.remove('dark-theme');
                // mobile
                document.getElementById("mobile-toggle-theme").innerText = "Â· Light"
            }
        })();
    </script>

    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">å¸ƒé²æ–¯é±¼çš„å¦™æƒ³å¤©å¼€</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">æŠ€æœ¯</a>
                
                    <a class="menu-item" href="/category">ç”Ÿæ´»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">å¸ƒé²æ–¯é±¼çš„å¦™æƒ³å¤©å¼€</a><a id="mobile-toggle-theme">Â·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">æŠ€æœ¯</a>
                
                    <a class="menu-item" href="/category">ç”Ÿæ´»</a>
                
                    <a class="menu-item" href="/tag">æ ‡ç­¾</a>
                
                    <a class="menu-item" href="/about">å…³äºæˆ‘</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
            <div class="main">
                <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    var tocbot_timer;
    var DEPTH_MAX = 6; // ä¸º 6 æ—¶å±•å¼€æ‰€æœ‰
    var tocbot_default_config = {
        tocSelector: '.tocbot-list',
        contentSelector: '.post-content',
        headingSelector: 'h1, h2, h3, h4, h5',
        orderedList: false,
        scrollSmooth: true,
        onClick: extend_click,
    };

    function extend_click() {
        clearTimeout(tocbot_timer);
        tocbot_timer = setTimeout(function() {
            tocbot.refresh(obj_merge(tocbot_default_config, {
                hasInnerContainers: true
            }));
        }, 420); // è¿™ä¸ªå€¼æ˜¯ç”± tocbot æºç é‡Œå®šä¹‰çš„ scrollSmoothDuration å¾—æ¥çš„
    }

    document.ready(function() {
        tocbot.init(obj_merge(tocbot_default_config, {
            collapseDepth: 1
        }));
    });

    function expand_toc() {
        var b = document.querySelector('.tocbot-toc-expand');
        var expanded = b.getAttribute('data-expanded');
        expanded ? b.removeAttribute('data-expanded') : b.setAttribute('data-expanded', true);
        tocbot.refresh(obj_merge(tocbot_default_config, {
            collapseDepth: expanded ? 1 : DEPTH_MAX
        }));
        b.innerText = expanded ? 'Expand all' : 'Collapse all';
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

    function obj_merge(target, source) {
        for (var item in source) {
            if (source.hasOwnProperty(item)) {
                target[item] = source[item];
            }
        }
        return target;
    }
</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">ğŸ§Ÿâ€â™‚ï¸ FileBeat å¯åŠ¨å‡æ­»é—®é¢˜</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Blues Yu</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">June 1, 2021&nbsp;&nbsp;15:20:34</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>ä¸Šå‘¨å› ä¸º OOM é—®é¢˜ï¼ŒæŸä¸ªé›†ç¾¤å†…çš„ Filebeat è¢«è¿«é‡å¯åï¼Œè§‚æµ‹äº†è®¸ä¹…ï¼Œä»ä¸è§äº‹ä»¶æµæ¢å¤ï¼ŒæŸ¥çœ‹ Filebeat è¾“å‡ºæ—¥å¿—ï¼Œå‘ç°åªæœ‰å…¶è‡ªç›‘æ§çš„æ—¥å¿—ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2021-05-28T03:19:41.061Z	INFO	[monitoring]	<span class="built_in">log</span>/log.go:145	Non-zero metrics <span class="keyword">in</span> the last 30s	&#123;<span class="string">&quot;monitoring&quot;</span>: &#123;<span class="string">&quot;metrics&quot;</span>: &#123;<span class="string">&quot;beat&quot;</span>:&#123;<span class="string">&quot;cpu&quot;</span>:&#123;<span class="string">&quot;system&quot;</span>:&#123;<span class="string">&quot;ticks&quot;</span>:6249680,<span class="string">&quot;time&quot;</span>:&#123;<span class="string">&quot;ms&quot;</span>:3024&#125;&#125;,<span class="string">&quot;total&quot;</span>:&#123;<span class="string">&quot;ticks&quot;</span>:13659880,<span class="string">&quot;time&quot;</span>:&#123;<span class="string">&quot;ms&quot;</span>:6612&#125;,<span class="string">&quot;value&quot;</span>:13659880&#125;,<span class="string">&quot;user&quot;</span>:&#123;<span class="string">&quot;ticks&quot;</span>:7410200,<span class="string">&quot;time&quot;</span>:&#123;<span class="string">&quot;ms&quot;</span>:3588&#125;&#125;&#125;,<span class="string">&quot;handles&quot;</span>:&#123;<span class="string">&quot;limit&quot;</span>:&#123;<span class="string">&quot;hard&quot;</span>:1048576,<span class="string">&quot;soft&quot;</span>:1048576&#125;,<span class="string">&quot;open&quot;</span>:46&#125;,<span class="string">&quot;info&quot;</span>:&#123;<span class="string">&quot;ephemeral_id&quot;</span>:<span class="string">&quot;ca641ad8-e10a-496f-a087-6924e456aaea&quot;</span>,<span class="string">&quot;uptime&quot;</span>:&#123;<span class="string">&quot;ms&quot;</span>:60180037&#125;&#125;,<span class="string">&quot;memstats&quot;</span>:&#123;<span class="string">&quot;gc_next&quot;</span>:42518272,<span class="string">&quot;memory_alloc&quot;</span>:31026880,<span class="string">&quot;memory_total&quot;</span>:1715304668248,<span class="string">&quot;rss&quot;</span>:-1552384&#125;,<span class="string">&quot;runtime&quot;</span>:&#123;<span class="string">&quot;goroutines&quot;</span>:206&#125;&#125;,<span class="string">&quot;filebeat&quot;</span>:&#123;<span class="string">&quot;events&quot;</span>:&#123;<span class="string">&quot;added&quot;</span>:139,<span class="string">&quot;done&quot;</span>:139&#125;,**<span class="string">&quot;harvester&quot;</span>:&#123;<span class="string">&quot;open_files&quot;</span>:0,<span class="string">&quot;running&quot;</span>:0&#125;&#125;**,<span class="string">&quot;libbeat&quot;</span>:&#123;<span class="string">&quot;config&quot;</span>:&#123;<span class="string">&quot;module&quot;</span>:&#123;<span class="string">&quot;running&quot;</span>:0&#125;&#125;,<span class="string">&quot;pipeline&quot;</span>:&#123;<span class="string">&quot;clients&quot;</span>:1,<span class="string">&quot;events&quot;</span>:&#123;<span class="string">&quot;active&quot;</span>:1,<span class="string">&quot;filtered&quot;</span>:139,<span class="string">&quot;total&quot;</span>:139&#125;,<span class="string">&quot;registrar&quot;</span>:&#123;<span class="string">&quot;states&quot;</span>:&#123;<span class="string">&quot;current&quot;</span>:55084,<span class="string">&quot;update&quot;</span>:13&#125;,<span class="string">&quot;writes&quot;</span>:&#123;<span class="string">&quot;success&quot;</span>:139,<span class="string">&quot;total&quot;</span>:139&#125;&#125;,<span class="string">&quot;system&quot;</span>:&#123;<span class="string">&quot;load&quot;</span>:&#123;<span class="string">&quot;1&quot;</span>:9.21,<span class="string">&quot;15&quot;</span>:10.97,<span class="string">&quot;5&quot;</span>:10.87,<span class="string">&quot;norm&quot;</span>:&#123;<span class="string">&quot;1&quot;</span>:0.3838,<span class="string">&quot;15&quot;</span>:0.4571,<span class="string">&quot;5&quot;</span>:0.4529&#125;&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>ä» <code>&quot;harvester&quot;:&#123;&quot;open_files&quot;:0,&quot;running&quot;:0&#125;&#125;</code> æˆ‘ä»¬å¯ä»¥åˆ¤æ–­å‡º  <code>harvester</code> å°šæœªå¯åŠ¨é‡‡é›†ï¼Œè¿™è®©æˆ‘éå¸¸ç–‘æƒ‘ï¼ŒFilebeat ç©¶ç«Ÿåœ¨åšä»€ä¹ˆï¼Ÿ</p>
<p>æ¥ç€è§‚å¯Ÿæ—¥å¿—ï¼Œå‘ç°é™¤å¼€è‡ªç›‘æ§ï¼Œæœ€åè¾“å‡ºä¸€æ¡æ—¥å¿—çš„å†…å®¹æ˜¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2021-05-28T02:46:39.019Z	INFO	beater/crawler.go:73	Loading Inputs: 1</span><br></pre></td></tr></table></figure>

<p><code>Loading Inputs</code> çœ‹èµ·æ¥ä¹Ÿæ˜¯ç¬¦åˆé€»è¾‘çš„ï¼ŒçŸ­æ—¶é—´æ²¡æœ‰å¤ªå¤šçš„å¤´ç»ªï¼Œæ”¾ä¸‹å¿™å…¶ä»–å·¥ä½œäº†ã€‚</p>
<p>éšç€æ—¶é—´æ¨ç§»ï¼Œå½“æˆ‘å†æ¬¡è§‚æµ‹ Filebeat æ—¶ï¼Œå‘ç°å®ƒå·²ç»åœ¨æ­£å¸¸å·¥ä½œäº†ï¼Œä½†æ˜¯æ—¥å¿—å†…ä¾æ—§æ²¡æœ‰é”™è¯¯è¾“å‡ºï¼Œæ‰¾åˆ°æ¢å¤æ—¶é—´ç‚¹çš„æœ€æ—©æ—¥å¿—ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2021-05-28T05:55:17.822Z	INFO	<span class="built_in">log</span>/input.go:152	Configured paths: [/data/logs/*/*.<span class="built_in">log</span>* /data/v3logs/*/*/*.<span class="built_in">log</span>*]</span><br><span class="line">2021-05-28T05:55:17.822Z	INFO	input/input.go:114	Starting input of <span class="built_in">type</span>: <span class="built_in">log</span>; ID: 3062577341473220485</span><br><span class="line">2021-05-28T05:55:17.822Z	INFO	beater/crawler.go:105	Loading and starting Inputs completed. Enabled inputs: 1</span><br></pre></td></tr></table></figure>

<p>å¥½å®¶ä¼™ï¼Œä» <code>Loading Inputs</code> â†’ <code>Loading and starting Inputs completed</code> èŠ±è´¹äº†3ä¸ªå¤šå°æ—¶ï¼Œè¿™æ›´è®©æˆ‘ç–‘æƒ‘äº†ï¼ŒFilebeat ç©¶ç«Ÿä¸ºä»€ä¹ˆä¸€ç›´è£…æ­»ï¼Ÿ</p>
<h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><p>æ ¹æ®æ—¥å¿—æ‰“å°ç¿»é˜…äº† Filebeat æºç </p>
<p><img src="/../images/%F0%9F%A7%9F%E2%80%8D%E2%99%82%EF%B8%8F%20FileBeat%20%E5%90%AF%E5%8A%A8%E5%81%87%E6%AD%BB%E9%97%AE%E9%A2%98/Untitled.png"><br><a target="_blank" rel="noopener" href="https://github.com/elastic/beats/blob/23e4403ae093fcc8f7905345cad2c7ad256976d8/filebeat/beater/crawler.go#L71">https://github.com/elastic/beats/blob/23e4403ae093fcc8f7905345cad2c7ad256976d8/filebeat/beater/crawler.go#L71</a></p>
<p><img src="/../images/%F0%9F%A7%9F%E2%80%8D%E2%99%82%EF%B8%8F%20FileBeat%20%E5%90%AF%E5%8A%A8%E5%81%87%E6%AD%BB%E9%97%AE%E9%A2%98/Untitled%201.png"><br><a target="_blank" rel="noopener" href="https://github.com/elastic/beats/blob/2ee21d95aef89af7f7e7aef8d07f679a24d690b4/filebeat/registrar/registrar.go#L172">https://github.com/elastic/beats/blob/2ee21d95aef89af7f7e7aef8d07f679a24d690b4/filebeat/registrar/registrar.go#L172</a></p>
<p>Filebeat ä½¿ç”¨ <code>registry file</code> ä½œä¸ºé‡‡é›†çš„çŠ¶æ€å­˜å‚¨ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªçº¯æ–‡æœ¬çš„ JSON æ–‡ä»¶ã€‚æ¯æ¬¡å¯åŠ¨æ—¶éƒ½ä¼šæ£€æŸ¥ JSON æ–‡ä»¶ä¸­çš„ <code>states</code> æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆæ–°å¢æˆ–è€…åˆ é™¤æ–‡ä»¶ï¼‰ï¼Œè€Œå½“ä»»ä½•ä¸€ä¸ª <code>state</code> éœ€è¦æ›´æ–°ï¼Œ <code>registry file</code> å°†ä¼šå…¨é‡åºåˆ—åŒ–(è¯») â†’ æŒä¹…åŒ–(å†™)ï¼Œéšç€ <code>states</code> è¶Šæ¥è¶Šå¤šï¼ŒJSON æ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼ˆæ¥è¿‘20MBï¼‰ï¼Œæ¯æ¬¡å…¨é‡è¯»å†™éƒ½ä¼šè¶Šæ¥è¶Šæ…¢ï¼Œå¹¶ä¸” CPUã€å†…å­˜çš„ä½¿ç”¨é‡éƒ½ä¼šæš´æ¶¨ã€‚</p>
<p><img src="/../images/%F0%9F%A7%9F%E2%80%8D%E2%99%82%EF%B8%8F%20FileBeat%20%E5%90%AF%E5%8A%A8%E5%81%87%E6%AD%BB%E9%97%AE%E9%A2%98/Untitled%202.png"></p>
<p>æ€»çš„æ¥è¯´ï¼Œåœ¨å½“å‰çš„æ•°æ®å­˜å‚¨é€‰å‹ä¸‹ï¼ŒFilebeat æ— æ³•åº”å¯¹è¿‡å¤šçš„æ–‡ä»¶æ•°æ®æ•°é‡ï¼Œå¯åŠ¨æ—¶çš„æ•°æ®æ ¸éªŒæ—¶é—´è¿‡é•¿ï¼ˆå‡ å°æ—¶â†’å‡ å¤©ä¸ç­‰ï¼Œè§†æ•°æ®é‡è€Œå®šï¼‰ï¼Œå°±ä¼šäº§ç”Ÿäº†â€œå‡æ­»â€çš„ç°è±¡ã€‚</p>
<h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><h3 id="ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆ"><a href="#ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆ"></a>ä¸´æ—¶çš„è§£å†³æ–¹æ¡ˆ</h3><p>æš‚åœ Filebeat è¿›ç¨‹ï¼Œåˆ é™¤ <code>registry file</code> ï¼Œé‡å¯ Filebeat è¿›ç¨‹ã€‚è¿™æ—¶å€™ç”±äº JSON æ–‡ä»¶æ˜¯æ¯”è¾ƒå°çš„ï¼Œæ‰€æœ‰ <code>state</code> å‡å¤„äºå¢é‡çŠ¶æ€ï¼Œæ•°æ®åŒæ­¥æ˜¯æ¯”è¾ƒå¿«çš„ã€‚ä½†æ˜¯æ‰€æœ‰å·²ç»å‘é€è¿‡çš„äº‹ä»¶å°†éš¾ä»¥**é¿å…åœ°é‡å¤å‘é€ä¸€æ¬¡ï¼Œ**æ‰€ä»¥è¿™ç§åšæ³•åªèƒ½åº”æ€¥ï¼Œä¸èƒ½é•¿ä¹…å¤„ç†ã€‚</p>
<h3 id="é•¿ä¹…çš„æƒå®œä¹‹è®¡"><a href="#é•¿ä¹…çš„æƒå®œä¹‹è®¡" class="headerlink" title="é•¿ä¹…çš„æƒå®œä¹‹è®¡"></a>é•¿ä¹…çš„æƒå®œä¹‹è®¡</h3><p>Filebeat çš„çº¯æ–‡æœ¬çš„ JSON å­˜å‚¨é€‰å‹å¤©ç”Ÿå°±æ˜¯å­˜åœ¨é—®é¢˜çš„ï¼Œç¤¾åŒºå†…ä¹Ÿæ›¾åšè¿‡ä¸€äº›<a target="_blank" rel="noopener" href="https://github.com/elastic/beats/pull/12908">å°æ”¹è¿›çš„å°è¯•</a>ï¼Œæœ€ç»ˆå¹¶æ²¡æœ‰è¢«åˆå¹¶åˆ°æŸ±åˆ†æã€‚æ‰€ä»¥ Filebeat æ— æ³•åº”ç”¨è¿‡å¤šçš„æ—¥å¿—æ–‡ä»¶ï¼Œè¿™æ˜¯ä¸€ä¸ªçŸ­æœŸå†…æ— æ³•æ”¹å˜çš„äº‹å®ã€‚</p>
<p>è€Œåœ¨å½“å‰é€‰æ‹©çš„<a href="https://emergencyexit.xyz/elk-back-pressure-study.html">ä¾èµ–èƒŒå‹çš„é‡‡é›†æ–¹æ¡ˆ</a> ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸å€¾å‘å°†æ—¥å¿—æ–‡ä»¶ç•™åœ¨é‡‡é›†ç®¡é“ä¸­ï¼Œè€Œæ˜¯å°†æ—¥å¿—ç•™åœ¨åŸå¤„â€”â€”æœºå™¨çš„ç£ç›˜ä¸Šï¼Œç„¶åå°½é‡ä¿è¯ç®¡é“çš„é€šç•…ï¼Œå°†æ—¥å¿—å®æ—¶é‡‡é›†åˆ° ES ä¸­ã€‚</p>
<p>è¿™æ ·åšçš„å¥½å¤„ï¼Œå°±æ˜¯é¿å…å› ä¸ºè¿‡å¤šçš„ç®¡é“ä¼ è¾“å¯¼è‡´æ—¥å¿—ä¸¢å¤±ï¼ˆä¾‹å¦‚ Redis å†™æ»¡åå´©æºƒï¼‰ã€‚</p>
<p>åŒæ—¶ä¹Ÿä¼šå¼•å…¥å¦ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœé‡‡é›†é“¾è·¯é˜»å¡ï¼ŒåŒæ—¶è¿‡å¤šçš„æ—¥å¿—ï¼ˆé‡‡é›†æ¡ç›®æ¯æ—¥2äº¿+ï¼‰å¤§äºæœºå™¨çš„ç£ç›˜æ‰¿è½½èƒ½åŠ›æ—¶ï¼Œæ—¥å¿—ä¸¢å¤±çš„é£é™©ä¾æ—§å­˜åœ¨ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦å®šæœŸæ¸…ç†è¿‡æœŸçš„æ—¥å¿—ï¼Œä½†é—®é¢˜ä¹Ÿæ²¡é‚£ä¹ˆç®€å•ï¼š</p>
<ul>
<li>ç›´æ¥åˆ é™¤æ—¥å¿—æ–‡ä»¶  â†’ å†™æ—¥å¿—çš„<a target="_blank" rel="noopener" href="https://stackoverflow.com/a/2031100/6122939">åº”ç”¨è¿›ç¨‹æ— æ³•æ„ŸçŸ¥ï¼Œå°†å‘æ— æ•ˆæ–‡ä»¶å¥æŸ„å†™æ—¥å¿—</a> â†’ å¯¼è‡´æ—¥å¿—ä¸¢å¤±</li>
<li>æ¸…ç©ºæ–‡ä»¶æ—¥å¿—å†…å®¹( <code>echo &#39;&#39; &gt; &#123;&#125;</code>) â†’ å¯¼è‡´æ–‡ä»¶æ•°é‡ä¸ä¼šå‡å°‘</li>
<li>å¦‚æœå› ä¸ºç¡¬ç›˜å®¹é‡é™åˆ¶ï¼Œåˆ é™¤æ—¥å¿—çš„å‘¨æœŸå°äº<em>äº§å“è®¸è¯ºçš„æ—¥å¿—ä¿å­˜æ—¶é•¿</em>ï¼Œå½“é“¾è·¯å‡ºç°å µå¡åˆæœªèƒ½åŠæ—¶å¤„ç† â†’ å¯¼è‡´æ—¥å¿—ä¸¢å¤±</li>
</ul>
<p>æ‰€ä»¥æˆ‘å†™äº†ä¸€ä¸ª <a target="_blank" rel="noopener" href="https://gist.github.com/IMBlues/2803c02420d01309d33f9d26ee501223">åˆ é™¤è„šæœ¬</a>ï¼Œåœ¨ä¿è¯æ¸…ç†è¿‡æœŸæ—¥å¿—çš„åŒæ—¶ï¼Œä¼šåˆ¤æ–­æ—¥å¿—æ–‡ä»¶çš„å¥æŸ„ä½¿ç”¨æƒ…å†µï¼Œè·³è¿‡é‚£äº›ä»åœ¨è¢«å†™å…¥çš„æ–‡ä»¶ï¼Œä¿è¯æ—¥å¿—ä¸ä¸¢å¤±ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> getopt</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> Generator, <span class="type">Dict</span></span><br><span class="line"></span><br><span class="line">logging.basicConfig(level=logging.DEBUG)</span><br><span class="line"></span><br><span class="line">Process = namedtuple(<span class="string">&quot;Process&quot;</span>, <span class="string">&quot;command,pid,user&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_processes_open</span>(<span class="params">file_regex: <span class="built_in">str</span></span>) -&gt; <span class="type">Dict</span>[<span class="built_in">str</span>, Process]:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Find processes with open handles for the specified file(s).&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    open_file_process_map = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># maybe not safe</span></span><br><span class="line">        output = subprocess.getoutput(<span class="string">f&quot;echo <span class="subst">&#123;file_regex&#125;</span> | xargs lsof&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        logging.exception(<span class="string">&quot;exec error&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> open_file_process_map</span><br><span class="line"></span><br><span class="line">    lines = output.split(<span class="string">&quot;\n&quot;</span>)[<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">        parts = [x <span class="keyword">for</span> x <span class="keyword">in</span> line.split(<span class="string">&quot; &quot;</span>) <span class="keyword">if</span> x]</span><br><span class="line">        open_file_process_map[parts[-<span class="number">1</span>]] = Process(*parts[:<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> open_file_process_map</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">try_to_delete_files</span>(<span class="params">file_regex: <span class="built_in">str</span>, minutes: <span class="built_in">int</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Try to delete files&quot;&quot;&quot;</span></span><br><span class="line">    skipped_count = deleted_count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">filter_files_by_expire_minutes</span>() -&gt; Generator[Path, <span class="literal">None</span>, <span class="literal">None</span>]:</span><br><span class="line">        <span class="string">&quot;&quot;&quot;Get all expired files&quot;&quot;&quot;</span></span><br><span class="line">        now = datetime.datetime.now()</span><br><span class="line">        <span class="keyword">for</span> name <span class="keyword">in</span> glob.glob(file_regex, recursive=<span class="literal">True</span>):</span><br><span class="line">            file_obj = Path(name)</span><br><span class="line">            updated = datetime.datetime.fromtimestamp(file_obj.stat().st_mtime)</span><br><span class="line">            <span class="keyword">if</span> updated &lt; now - datetime.timedelta(minutes=minutes):</span><br><span class="line">                <span class="keyword">yield</span> file_obj</span><br><span class="line"></span><br><span class="line">    open_file_process_map = get_processes_open(file_regex)</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> filter_files_by_expire_minutes():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(f) <span class="keyword">not</span> <span class="keyword">in</span> open_file_process_map:</span><br><span class="line">            logging.info(<span class="string">f&quot;deleting <span class="subst">&#123;f&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.unlink()</span><br><span class="line">                deleted_count += <span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                skipped_count += <span class="number">1</span></span><br><span class="line">                logging.warning(<span class="string">&quot;failed to delete file: %s, for: %s&quot;</span>, <span class="built_in">str</span>(f), e)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            skipped_count += <span class="number">1</span></span><br><span class="line">            logging.info(<span class="string">f&quot;skipping <span class="subst">&#123;f&#125;</span>, for process: <span class="subst">&#123;open_file_process_map[<span class="built_in">str</span>(f)]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Skipped: <span class="subst">&#123;skipped_count&#125;</span>, deleted: <span class="subst">&#123;deleted_count&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        opts, args = getopt.getopt(sys.argv[<span class="number">1</span>:], <span class="string">&quot;hf:m:&quot;</span>, [<span class="string">&quot;files=&quot;</span>, <span class="string">&quot;minutes=&quot;</span>])</span><br><span class="line">    <span class="keyword">except</span> getopt.GetoptError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Example: python delete_files.py -f /data/*/*.log* -m 1440&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    arg_files = <span class="string">&quot;&quot;</span></span><br><span class="line">    arg_minutes = <span class="number">1440</span></span><br><span class="line">    <span class="keyword">for</span> opt, arg <span class="keyword">in</span> opts:</span><br><span class="line">        <span class="keyword">if</span> opt == <span class="string">&quot;-h&quot;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Usage: python delete_files.py -f /data/*/*.log* -m 1440&quot;</span>)</span><br><span class="line">            sys.exit(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">&quot;-f&quot;</span>, <span class="string">&quot;--files&quot;</span>):</span><br><span class="line">            arg_files = arg</span><br><span class="line">        <span class="keyword">elif</span> opt <span class="keyword">in</span> (<span class="string">&quot;-m&quot;</span>, <span class="string">&quot;--minutes&quot;</span>):</span><br><span class="line">            arg_minutes = <span class="built_in">int</span>(arg)</span><br><span class="line"></span><br><span class="line">    started = datetime.datetime.now()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Started: <span class="subst">&#123;started&#125;</span>\n&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>)</span><br><span class="line">    try_to_delete_files(arg_files, arg_minutes)</span><br><span class="line">    finished = datetime.datetime.now()</span><br><span class="line">    <span class="built_in">print</span>(</span><br><span class="line">        <span class="string">f&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;\nFinished: <span class="subst">&#123;finished&#125;</span>, total cost: <span class="subst">&#123;(finished - started).total_seconds()&#125;</span> seconds \n&quot;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚ç”¨ Bash å®ç°ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚<em><del>ï¼ˆå…¶å®å°±æ˜¯æˆ‘ä¸ä¼š Bashï¼‰</del></em></p>
<p>ç„¶åæˆ‘ä»¬éœ€è¦å°†å®ƒè·‘åœ¨é›†ç¾¤ä¸­çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®šæœŸæ‰§è¡Œæ¸…ç†å·¥ä½œï¼š</p>
<p>é¦–å…ˆå®šä¹‰é•œåƒ</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y lsof</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> delete_files.py /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;python&quot;</span>, <span class="string">&quot;./delete_files.py&quot;</span>, <span class="string">&quot;-f&quot;</span>, <span class="string">&quot;./*.no&quot;</span>, <span class="string">&quot;-m&quot;</span>, <span class="string">&quot;1440&quot;</span> ]</span></span><br></pre></td></tr></table></figure>

<p>Kubernetes DaemonSet å®šä¹‰ï¼Œåœ¨æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸Šéƒ½å°è¯•æ¸…ç†æ—¥å¿—ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">log-cleaner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">log-cleaner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">log-cleaner</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">log-cleaner</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">log-cleaner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">batch-delete-files</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">some-registry/batch-delete-files:v1.0.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">Always</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;bash&quot;</span>]</span><br><span class="line">        <span class="attr">args:</span> [<span class="string">&quot;-c&quot;</span>, <span class="string">&quot;while true; do python delete_files.py -f /some-path/*/*/*.log* -m 1440; sleep 3600; done;&quot;</span>]</span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">2560m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">256Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">25m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">32Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/some-path/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">some-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">some-volume</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/some-path/</span></span><br></pre></td></tr></table></figure>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬éœ€è¦åœ¨å®¹å™¨å†…ä½¿ç”¨ <code>lsof</code> æ¥çœ‹æŸ¥çœ‹æ¯æœºæ–‡ä»¶çš„ <code>fd</code> ä½¿ç”¨æƒ…å†µï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦é¢å¤–æ·»åŠ  <code>hostPID: true</code> æ¥ä¿è¯èƒ½å¤Ÿè¯»å–åˆ°æ¯æœºçš„è¿›ç¨‹ä¿¡æ¯ã€‚</p>
<p>ç”±äºæˆ‘ä»¬éœ€è¦å®šæ—¶æ‰§è¡Œï¼Œæ‰€ä»¥é€šè¿‡ <code>while true; do ... sleep 3600; done;</code> æ¥è¦é¢å¤–æ§åˆ¶æ‰§è¡Œå‘¨æœŸã€‚</p>
<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2><p>ç”±äº Filebeat å­˜åœ¨å¤©ç”Ÿçš„å­˜å‚¨ç¼ºé™·ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡é¢å¤–çš„è„šæœ¬è¾ƒä¸ºç²¾ç¡®çš„æ§åˆ¶ Filebeat çš„è¾“å…¥æ–‡ä»¶æ•°é‡ï¼Œå½“å‰çš„æ–¹æ¡ˆæ–­ç„¶è¾¾ä¸åˆ°å®Œå–„ï¼Œä»éœ€è¦æˆ‘ä»¬ç»§ç»­æ¢ç´¢ã€‚</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/elastic/beats/issues/16076">https://github.com/elastic/beats/issues/16076</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/36186630/python-error-subprocess-calledprocesserror-command-returned-non-zero-exit-stat">https://stackoverflow.com/questions/36186630/python-error-subprocess-calledprocesserror-command-returned-non-zero-exit-stat</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/55901375/is-this-possible-to-schedule-cronjob-to-execute-on-each-of-kubernetes-nodes">https://stackoverflow.com/questions/55901375/is-this-possible-to-schedule-cronjob-to-execute-on-each-of-kubernetes-nodes</a></li>
</ul>

        </div>

        
            <section class="post-copyright">
                
                    <p class="copyright-item">
                        <span>Author:</span>
                        <span>Blues Yu</span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>Permalink:</span>
                        <span><a href="https://emergencyexit.xyz/filebeat-hangs-problem.html">https://emergencyexit.xyz/filebeat-hangs-problem.html</a></span>
                    </p>
                
                
                    <p class="copyright-item">
                        <span>License:</span>
                        <span>Copyright (c) 2025 <a target="_blank" rel="noopener" href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span>
                    </p>
                
                

            </section>
        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/tech/"># tech</a>
                    
                        <a href="/tags/best-practice/"># best-practice</a>
                    
                        <a href="/tags/k8s/"># k8s</a>
                    
                        <a href="/tags/ELK/"># ELK</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>Â· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/cue-vs-helm.html">ğŸ‘‹ å†è§ Helmï¼Œä½ å¥½ CUE</a>
            
            
            <a class="next" rel="next" href="/make-serializer-as-dependency-injector.html">ğŸ‘´ è®© DRF Views æ”¯æŒä¾èµ–æ³¨å…¥</a>
            
        </section>


    </article>
</div>

            </div>
            <footer id="footer" class="footer">
    <div class="copyright">
        <span>Â© Blues Yu | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>

    </div>
</body>

</html>